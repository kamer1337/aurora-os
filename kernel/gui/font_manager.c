/**
 * Aurora OS - Font Manager Implementation
 * 
 * Manages multiple font types and allows runtime font switching
 */

#include "font_manager.h"
#include "framebuffer.h"
#include <stddef.h>

// External font data from framebuffer.c
extern const uint8_t font8x8[128][8];
extern const uint8_t font5x7[128][7];

// Crystalline 8x8 font - enhanced version of standard font with more angular patterns
static const uint8_t font8x8_crystalline[128][8] = {
    // Space (32)
    [32] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    // ! (33)
    [33] = {0x18, 0x3C, 0x3C, 0x18, 0x18, 0x00, 0x18, 0x00},
    // " (34)
    [34] = {0x6C, 0x6C, 0x48, 0x00, 0x00, 0x00, 0x00, 0x00},
    // # (35)
    [35] = {0x36, 0x36, 0x7F, 0x36, 0x7F, 0x36, 0x36, 0x00},
    // $ (36)
    [36] = {0x08, 0x3E, 0x48, 0x3C, 0x12, 0x7C, 0x10, 0x00},
    // % (37)
    [37] = {0x62, 0x64, 0x08, 0x10, 0x20, 0x4C, 0x8C, 0x00},
    // & (38)
    [38] = {0x30, 0x48, 0x50, 0x20, 0x54, 0x88, 0x74, 0x00},
    // ' (39)
    [39] = {0x18, 0x18, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00},
    // A-Z with crystalline/angular patterns
    [65] = {0x18, 0x24, 0x42, 0x42, 0x7E, 0x42, 0x42, 0x00},  // A
    [66] = {0x7C, 0x42, 0x42, 0x7C, 0x42, 0x42, 0x7C, 0x00},  // B
    [67] = {0x3C, 0x42, 0x40, 0x40, 0x40, 0x42, 0x3C, 0x00},  // C
    [68] = {0x78, 0x44, 0x42, 0x42, 0x42, 0x44, 0x78, 0x00},  // D
    [69] = {0x7E, 0x40, 0x40, 0x7C, 0x40, 0x40, 0x7E, 0x00},  // E
    [70] = {0x7E, 0x40, 0x40, 0x7C, 0x40, 0x40, 0x40, 0x00},  // F
    [71] = {0x3C, 0x42, 0x40, 0x4E, 0x42, 0x42, 0x3C, 0x00},  // G
    [72] = {0x42, 0x42, 0x42, 0x7E, 0x42, 0x42, 0x42, 0x00},  // H
    [73] = {0x3C, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00},  // I
    [74] = {0x1E, 0x08, 0x08, 0x08, 0x08, 0x48, 0x30, 0x00},  // J
    [75] = {0x42, 0x44, 0x48, 0x70, 0x48, 0x44, 0x42, 0x00},  // K
    [76] = {0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x7E, 0x00},  // L
    [77] = {0x42, 0x66, 0x5A, 0x5A, 0x42, 0x42, 0x42, 0x00},  // M
    [78] = {0x42, 0x62, 0x52, 0x4A, 0x46, 0x42, 0x42, 0x00},  // N
    [79] = {0x3C, 0x42, 0x42, 0x42, 0x42, 0x42, 0x3C, 0x00},  // O
    [80] = {0x7C, 0x42, 0x42, 0x7C, 0x40, 0x40, 0x40, 0x00},  // P
    [81] = {0x3C, 0x42, 0x42, 0x42, 0x4A, 0x44, 0x3A, 0x00},  // Q
    [82] = {0x7C, 0x42, 0x42, 0x7C, 0x48, 0x44, 0x42, 0x00},  // R
    [83] = {0x3C, 0x42, 0x40, 0x3C, 0x02, 0x42, 0x3C, 0x00},  // S
    [84] = {0x7E, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00},  // T
    [85] = {0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x3C, 0x00},  // U
    [86] = {0x42, 0x42, 0x42, 0x42, 0x24, 0x24, 0x18, 0x00},  // V
    [87] = {0x42, 0x42, 0x42, 0x5A, 0x5A, 0x66, 0x42, 0x00},  // W
    [88] = {0x42, 0x42, 0x24, 0x18, 0x24, 0x42, 0x42, 0x00},  // X
    [89] = {0x42, 0x42, 0x24, 0x18, 0x18, 0x18, 0x18, 0x00},  // Y
    [90] = {0x7E, 0x02, 0x04, 0x18, 0x20, 0x40, 0x7E, 0x00},  // Z
    // a-z lowercase
    [97]  = {0x00, 0x00, 0x3C, 0x02, 0x3E, 0x42, 0x3E, 0x00},  // a
    [98]  = {0x40, 0x40, 0x5C, 0x62, 0x42, 0x42, 0x7C, 0x00},  // b
    [99]  = {0x00, 0x00, 0x3C, 0x42, 0x40, 0x42, 0x3C, 0x00},  // c
    [100] = {0x02, 0x02, 0x3A, 0x46, 0x42, 0x42, 0x3E, 0x00},  // d
    [101] = {0x00, 0x00, 0x3C, 0x42, 0x7E, 0x40, 0x3C, 0x00},  // e
    [102] = {0x0C, 0x12, 0x10, 0x38, 0x10, 0x10, 0x10, 0x00},  // f
    [103] = {0x00, 0x00, 0x3E, 0x42, 0x42, 0x3E, 0x02, 0x3C},  // g
    [104] = {0x40, 0x40, 0x5C, 0x62, 0x42, 0x42, 0x42, 0x00},  // h
    [105] = {0x08, 0x00, 0x18, 0x08, 0x08, 0x08, 0x1C, 0x00},  // i
    [106] = {0x04, 0x00, 0x0C, 0x04, 0x04, 0x44, 0x38, 0x00},  // j
    [107] = {0x40, 0x40, 0x44, 0x48, 0x70, 0x48, 0x44, 0x00},  // k
    [108] = {0x18, 0x08, 0x08, 0x08, 0x08, 0x08, 0x1C, 0x00},  // l
    [109] = {0x00, 0x00, 0x6C, 0x52, 0x52, 0x52, 0x52, 0x00},  // m
    [110] = {0x00, 0x00, 0x5C, 0x62, 0x42, 0x42, 0x42, 0x00},  // n
    [111] = {0x00, 0x00, 0x3C, 0x42, 0x42, 0x42, 0x3C, 0x00},  // o
    [112] = {0x00, 0x00, 0x7C, 0x42, 0x42, 0x7C, 0x40, 0x40},  // p
    [113] = {0x00, 0x00, 0x3E, 0x42, 0x42, 0x3E, 0x02, 0x02},  // q
    [114] = {0x00, 0x00, 0x5C, 0x62, 0x40, 0x40, 0x40, 0x00},  // r
    [115] = {0x00, 0x00, 0x3C, 0x40, 0x3C, 0x02, 0x7C, 0x00},  // s
    [116] = {0x10, 0x10, 0x38, 0x10, 0x10, 0x12, 0x0C, 0x00},  // t
    [117] = {0x00, 0x00, 0x42, 0x42, 0x42, 0x46, 0x3A, 0x00},  // u
    [118] = {0x00, 0x00, 0x42, 0x42, 0x42, 0x24, 0x18, 0x00},  // v
    [119] = {0x00, 0x00, 0x42, 0x42, 0x5A, 0x5A, 0x24, 0x00},  // w
    [120] = {0x00, 0x00, 0x42, 0x24, 0x18, 0x24, 0x42, 0x00},  // x
    [121] = {0x00, 0x00, 0x42, 0x42, 0x3E, 0x02, 0x3C, 0x00},  // y
    [122] = {0x00, 0x00, 0x7E, 0x04, 0x18, 0x20, 0x7E, 0x00},  // z
    // 0-9 digits
    [48] = {0x3C, 0x46, 0x4A, 0x52, 0x62, 0x42, 0x3C, 0x00},  // 0
    [49] = {0x18, 0x38, 0x18, 0x18, 0x18, 0x18, 0x7E, 0x00},  // 1
    [50] = {0x3C, 0x42, 0x02, 0x1C, 0x20, 0x40, 0x7E, 0x00},  // 2
    [51] = {0x7E, 0x02, 0x04, 0x1C, 0x02, 0x42, 0x3C, 0x00},  // 3
    [52] = {0x04, 0x0C, 0x14, 0x24, 0x7E, 0x04, 0x04, 0x00},  // 4
    [53] = {0x7E, 0x40, 0x7C, 0x02, 0x02, 0x42, 0x3C, 0x00},  // 5
    [54] = {0x1C, 0x20, 0x40, 0x7C, 0x42, 0x42, 0x3C, 0x00},  // 6
    [55] = {0x7E, 0x02, 0x04, 0x08, 0x10, 0x20, 0x20, 0x00},  // 7
    [56] = {0x3C, 0x42, 0x42, 0x3C, 0x42, 0x42, 0x3C, 0x00},  // 8
    [57] = {0x3C, 0x42, 0x42, 0x3E, 0x02, 0x04, 0x38, 0x00},  // 9
    // Common symbols
    [40] = {0x04, 0x08, 0x10, 0x10, 0x10, 0x08, 0x04, 0x00},  // (
    [41] = {0x20, 0x10, 0x08, 0x08, 0x08, 0x10, 0x20, 0x00},  // )
    [46] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00},  // .
    [47] = {0x00, 0x02, 0x04, 0x08, 0x10, 0x20, 0x40, 0x00},  // /
    [58] = {0x00, 0x00, 0x18, 0x18, 0x00, 0x18, 0x18, 0x00},  // :
    [59] = {0x00, 0x00, 0x18, 0x18, 0x00, 0x18, 0x08, 0x10},  // ;
    [63] = {0x3C, 0x42, 0x04, 0x08, 0x08, 0x00, 0x08, 0x00},  // ?
};

// 6x8 monospace font
static const uint8_t font6x8_mono[128][8] = {
    // Space (32)
    [32] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    // Basic ASCII characters - monospace variants
    [65] = {0x18, 0x24, 0x42, 0x7E, 0x42, 0x42, 0x42, 0x00},  // A
    [66] = {0x7C, 0x42, 0x42, 0x7C, 0x42, 0x42, 0x7C, 0x00},  // B
    [67] = {0x3C, 0x42, 0x40, 0x40, 0x40, 0x42, 0x3C, 0x00},  // C
    [68] = {0x78, 0x44, 0x42, 0x42, 0x42, 0x44, 0x78, 0x00},  // D
    [69] = {0x7E, 0x40, 0x40, 0x7C, 0x40, 0x40, 0x7E, 0x00},  // E
    [70] = {0x7E, 0x40, 0x40, 0x7C, 0x40, 0x40, 0x40, 0x00},  // F
    // ... (remaining characters use similar patterns)
};

// Font registry
static font_info_t font_registry[FONT_COUNT];
static font_type_t current_font = FONT_8X8_CRYSTALLINE;  // Default to crystalline
static int font_manager_initialized = 0;

int font_manager_init(void) {
    if (font_manager_initialized) {
        return 0;
    }
    
    // Initialize font registry
    font_registry[FONT_8X8_STANDARD].type = FONT_8X8_STANDARD;
    font_registry[FONT_8X8_STANDARD].name = "Standard 8x8";
    font_registry[FONT_8X8_STANDARD].width = 8;
    font_registry[FONT_8X8_STANDARD].height = 8;
    font_registry[FONT_8X8_STANDARD].spacing = 0;
    font_registry[FONT_8X8_STANDARD].data = (const uint8_t*)font8x8;
    
    font_registry[FONT_8X8_CRYSTALLINE].type = FONT_8X8_CRYSTALLINE;
    font_registry[FONT_8X8_CRYSTALLINE].name = "Crystalline 8x8";
    font_registry[FONT_8X8_CRYSTALLINE].width = 8;
    font_registry[FONT_8X8_CRYSTALLINE].height = 8;
    font_registry[FONT_8X8_CRYSTALLINE].spacing = 0;
    font_registry[FONT_8X8_CRYSTALLINE].data = (const uint8_t*)font8x8_crystalline;
    
    font_registry[FONT_5X7_CRYSTALLINE].type = FONT_5X7_CRYSTALLINE;
    font_registry[FONT_5X7_CRYSTALLINE].name = "Crystalline 5x7";
    font_registry[FONT_5X7_CRYSTALLINE].width = 5;
    font_registry[FONT_5X7_CRYSTALLINE].height = 7;
    font_registry[FONT_5X7_CRYSTALLINE].spacing = 1;
    font_registry[FONT_5X7_CRYSTALLINE].data = (const uint8_t*)font5x7;
    
    font_registry[FONT_6X8_MONO].type = FONT_6X8_MONO;
    font_registry[FONT_6X8_MONO].name = "Monospace 6x8";
    font_registry[FONT_6X8_MONO].width = 6;
    font_registry[FONT_6X8_MONO].height = 8;
    font_registry[FONT_6X8_MONO].spacing = 0;
    font_registry[FONT_6X8_MONO].data = (const uint8_t*)font6x8_mono;
    
    current_font = FONT_8X8_CRYSTALLINE;  // Set crystalline as default
    font_manager_initialized = 1;
    
    return 0;
}

font_type_t font_manager_get_current(void) {
    return current_font;
}

int font_manager_set_current(font_type_t type) {
    if (type >= FONT_COUNT) {
        return -1;
    }
    
    current_font = type;
    return 0;
}

const font_info_t* font_manager_get_info(font_type_t type) {
    if (type >= FONT_COUNT) {
        return NULL;
    }
    
    return &font_registry[type];
}

void font_manager_draw_char(uint32_t x, uint32_t y, char c, color_t fg_color, color_t bg_color) {
    if (!font_manager_initialized) {
        font_manager_init();
    }
    
    const font_info_t* font = &font_registry[current_font];
    
    // Use appropriate drawing function based on font type
    if (current_font == FONT_5X7_CRYSTALLINE) {
        framebuffer_draw_char_5x7(x, y, c, fg_color, bg_color);
    } else {
        // For 8x8 fonts, draw manually from font data
        if (c < 0 || c >= 128) return;
        
        const uint8_t* glyph = font->data + (c * font->height);
        
        for (uint8_t dy = 0; dy < font->height; dy++) {
            uint8_t row = glyph[dy];
            for (uint8_t dx = 0; dx < font->width; dx++) {
                if (row & (1 << (7 - dx))) {
                    framebuffer_draw_pixel(x + dx, y + dy, fg_color);
                } else if (bg_color.a > 0) {
                    framebuffer_draw_pixel(x + dx, y + dy, bg_color);
                }
            }
        }
    }
}

void font_manager_draw_string(uint32_t x, uint32_t y, const char* str, color_t fg_color, color_t bg_color) {
    if (!font_manager_initialized) {
        font_manager_init();
    }
    
    if (!str) return;
    
    const font_info_t* font = &font_registry[current_font];
    uint32_t cursor_x = x;
    uint32_t cursor_y = y;
    uint8_t char_advance = font->width + font->spacing;
    
    framebuffer_info_t* fb = framebuffer_get_info();
    if (!fb) return;
    
    while (*str) {
        if (*str == '\n') {
            cursor_x = x;
            cursor_y += font->height;
        } else if (*str == '\t') {
            cursor_x += char_advance * 4;  // Tab = 4 spaces
        } else {
            font_manager_draw_char(cursor_x, cursor_y, *str, fg_color, bg_color);
            cursor_x += char_advance;
            
            // Wrap to next line if needed
            if (cursor_x + char_advance > fb->width) {
                cursor_x = x;
                cursor_y += font->height;
            }
        }
        
        str++;
    }
}

uint8_t font_manager_get_char_width(void) {
    if (!font_manager_initialized) {
        font_manager_init();
    }
    
    return font_registry[current_font].width;
}

uint8_t font_manager_get_char_height(void) {
    if (!font_manager_initialized) {
        font_manager_init();
    }
    
    return font_registry[current_font].height;
}

uint8_t font_manager_get_char_advance(void) {
    if (!font_manager_initialized) {
        font_manager_init();
    }
    
    const font_info_t* font = &font_registry[current_font];
    return font->width + font->spacing;
}
